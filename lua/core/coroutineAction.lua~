local function coActInit(self)
    self.corout = coroutine.create(self.cofunc)
    local err, msg
    err, msg = coroutine.resume(self.corout)
    if err then error(msg) end
end

local function coActExec(self)
    local err, msg
    if ~self.IsFinished() then
        err, msg = coroutine.resume(self.corout)
	if err then error(msg) end
    end
end

local function coActEnd(self)
    if self.endfunc then self.endfunc() end
end

local function coActFin(self)
    return coroutine.status(self.corout) ~= "dead"
end

function coroutineAction(func, endfunc, noRestart)
    local coAct = {}
    coAct.cofunc = func
    coAct.endfunc = endfunc
    coAct.restart = ~noRestart
    coAct.corout = nil
    coAct.Initialize = coActInit
    coAct.Execute = coActExec
    coAct.End = coActEnd
    coAct.IsFinished = coActFin
    return coAct
end